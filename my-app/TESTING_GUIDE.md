# ğŸ§ª Complete Booking Flow Testing Guide

## ğŸ“‹ Overview

This guide will walk you through testing the complete booking flow: **Booking â†’ Payment â†’ Cancellation â†’ Refund**

---

## ğŸš€ Step 1: Setup Test Data

### 1.1 Run the Setup Script

```bash
cd my-app
node scripts/setup-test-booking.js
```

This will create:

- âœ… Test user: `test@baithaka.com`
- âœ… Test property: "Test Property for Booking Flow"
- âœ… Test booking with payment status "paid"

### 1.2 Verify Setup

Check the console output to confirm:

- Test user created successfully
- Test property created successfully
- Test booking created with payment status "paid"
- Booking amount: â‚¹7,500 (3 nights Ã— â‚¹2,500)

---

## ğŸ¯ Step 2: Test User Login

### 2.1 Login as Test User

1. **Open your browser** and go to `http://localhost:3000`
2. **Click "Login"** in the header
3. **Enter credentials:**
   - Email: `test@baithaka.com`
   - Password: `testpassword123`
4. **Click "Sign In"**

### 2.2 Verify Login

- âœ… You should be logged in successfully
- âœ… Your name should appear in the header
- âœ… You should have access to user dashboard

---

## ğŸ“– Step 3: View Test Booking

### 3.1 Navigate to Bookings

1. **Click on your profile** in the header
2. **Select "My Bookings"** or go directly to `http://localhost:3000/bookings`

### 3.2 Verify Test Booking

You should see:

- âœ… **Test booking** in the "Upcoming" tab
- âœ… **Property name**: "Test Property for Booking Flow"
- âœ… **Booking amount**: â‚¹7,500
- âœ… **Status**: "Confirmed" (green badge)
- âœ… **Check-in date**: 7 days from today
- âœ… **Check-out date**: 10 days from today

### 3.3 Booking Details

- **Booking Code**: Should show format like `BK-XXXXXX`
- **Payment Status**: Should show "Paid"
- **Cancel Button**: Should be visible and enabled

---

## ğŸ’³ Step 4: Test New Booking Flow (Optional)

### 4.1 Create a New Booking

1. **Go to homepage** `http://localhost:3000`
2. **Search for a property** or browse properties
3. **Select a property** and click "Book Now"
4. **Fill booking details:**
   - Check-in date (future date)
   - Check-out date
   - Number of guests
5. **Click "Proceed to Payment"**

### 4.2 Test Payment Flow

1. **Payment Gateway**: You'll be redirected to Razorpay
2. **Test Payment**: Use Razorpay test cards:
   - **Success**: `4111 1111 1111 1111`
   - **Failure**: `4000 0000 0000 0002`
3. **Complete Payment**: Enter any future expiry date and CVV

### 4.3 Verify Payment Success

- âœ… **Booking confirmed** message
- âœ… **Payment status**: "paid"
- âœ… **Booking appears** in "Upcoming" tab

---

## âŒ Step 5: Test Cancellation Flow

### 5.1 Cancel the Test Booking

1. **Go to** `http://localhost:3000/bookings`
2. **Find the test booking** in "Upcoming" tab
3. **Click "Cancel"** button
4. **Confirm cancellation** in the popup

### 5.2 Verify Cancellation

- âœ… **Booking status** changes to "Cancelled"
- âœ… **Booking moves** to "Cancelled" tab
- âœ… **Toast notification** appears with cancellation message

---

## ğŸ’° Step 6: Test Refund Flow

### 6.1 Check Refund Processing

After cancellation, you should see:

#### **If Automatic Refund Succeeds:**

- âœ… **Toast notification**: "Booking Cancelled with Refund"
- âœ… **Refund dialog** appears automatically
- âœ… **Refund amount**: â‚¹7,500
- âœ… **Refund status**: "Processed"
- âœ… **Refund ID**: Generated by Razorpay

#### **If Manual Refund Required:**

- âœ… **Toast notification**: "Booking Cancelled with Refund"
- âœ… **Refund dialog** appears automatically
- âœ… **Refund amount**: â‚¹7,500
- âœ… **Refund status**: "Processing"
- âœ… **Manual instructions** provided

### 6.2 Refund Dialog Details

The refund dialog should show:

- âœ… **Refund amount** prominently displayed
- âœ… **Processing timeline** (3-5 days for automatic, 5-7 days for manual)
- âœ… **Contact information** for support
- âœ… **Important notes** about refund process

### 6.3 Verify Database Updates

Check that the booking has been updated with:

- âœ… **Status**: "cancelled"
- âœ… **Payment Status**: "refunded"
- âœ… **Refund Amount**: â‚¹7,500
- âœ… **Refunded At**: Current timestamp
- âœ… **Cancellation Reason**: "Manual cancellation by user"

---

## ğŸ” Step 7: Admin Verification

### 7.1 Login as Admin

1. **Go to** `http://localhost:3000/admin/login`
2. **Login with admin credentials**
3. **Navigate to** `http://localhost:3000/admin/bookings`

### 7.2 Verify Admin View

In admin bookings, you should see:

- âœ… **Test booking** in the list
- âœ… **Status**: "Cancelled"
- âœ… **Payment Status**: "Refunded"
- âœ… **Refund Amount**: â‚¹7,500
- âœ… **Cancellation details** in booking information

### 7.3 Test Admin Cancellation

1. **Find the test booking** in admin list
2. **Click dropdown** (three dots)
3. **Select "Cancel Booking"**
4. **Confirm cancellation**
5. **Verify** refund processing works from admin side too

---

## ğŸ§ª Step 8: Test Edge Cases

### 8.1 Test Refund API Directly

```bash
# Test refund status API
curl -X GET "http://localhost:3000/api/bookings/{BOOKING_ID}/refund" \
  -H "Cookie: your-session-cookie"
```

### 8.2 Test Refund Service

```bash
# Test refund service (admin only)
curl -X POST "http://localhost:3000/api/test-refund" \
  -H "Cookie: your-admin-session-cookie"
```

### 8.3 Test Different Payment Statuses

1. **Create booking with payment status "pending"**
2. **Cancel it** - should not trigger refund
3. **Create booking with payment status "failed"**
4. **Cancel it** - should not trigger refund

---

## ğŸ“Š Step 9: Monitor Logs

### 9.1 Check Console Logs

During testing, monitor these log messages:

- âœ… `[BookingService] Processing refund for paid booking`
- âœ… `[RefundService] Processing refund for booking: {id}`
- âœ… `[RefundService] Razorpay refund successful: {refund_id}`
- âœ… `[RefundService] Refund processed successfully`

### 9.2 Check Database

Verify in MongoDB:

```javascript
// Check booking status
db.bookings.findOne({ _id: ObjectId("your-booking-id") });

// Check refund fields
db.bookings.findOne(
  { _id: ObjectId("your-booking-id") },
  { refundAmount: 1, refundStatus: 1, refundedAt: 1, paymentStatus: 1 }
);
```

---

## ğŸ¯ Expected Results

### âœ… Successful Flow:

1. **Booking Creation**: âœ… User can create booking
2. **Payment Processing**: âœ… Payment gateway integration works
3. **Booking Confirmation**: âœ… Booking appears in upcoming
4. **Cancellation**: âœ… User can cancel booking
5. **Refund Processing**: âœ… Automatic refund through Razorpay
6. **Refund Instructions**: âœ… User sees detailed refund dialog
7. **Status Updates**: âœ… Database properly updated
8. **Admin View**: âœ… Admin can see all refund details

### âŒ Common Issues to Check:

- **Payment Gateway**: Ensure Razorpay credentials are set
- **Database Connection**: Verify MongoDB connection
- **Session Management**: Check user authentication
- **API Endpoints**: Verify all refund APIs are working
- **UI Components**: Ensure refund dialog displays correctly

---

## ğŸ”§ Troubleshooting

### Issue: Refund not processing

**Solution:**

1. Check Razorpay credentials in `.env`
2. Verify payment ID exists in booking
3. Check console for error messages
4. Test with manual refund fallback

### Issue: Refund dialog not showing

**Solution:**

1. Check browser console for errors
2. Verify refund data structure
3. Ensure Dialog component is imported
4. Check React state management

### Issue: Database not updating

**Solution:**

1. Check MongoDB connection
2. Verify booking ID format
3. Check user authorization
4. Review database schema

---

## ğŸ‰ Success Criteria

You've successfully tested the complete flow when:

- âœ… User can create and pay for booking
- âœ… Booking appears in upcoming with "Confirmed" status
- âœ… User can cancel booking with confirmation
- âœ… Refund processes automatically through Razorpay
- âœ… Refund dialog shows with detailed instructions
- âœ… Booking moves to "Cancelled" tab
- âœ… Admin can see all refund details
- âœ… Database properly tracks all refund information

**Congratulations! ğŸ‰ Your booking, payment, cancellation, and refund system is working perfectly!**
