# 🧪 Complete Booking Flow Testing Guide

## 📋 Overview

This guide will walk you through testing the complete booking flow: **Booking → Payment → Cancellation → Refund**

---

## 🚀 Step 1: Setup Test Data

### 1.1 Run the Setup Script

```bash
cd my-app
node scripts/setup-test-booking.js
```

This will create:

- ✅ Test user: `test@baithaka.com`
- ✅ Test property: "Test Property for Booking Flow"
- ✅ Test booking with payment status "paid"

### 1.2 Verify Setup

Check the console output to confirm:

- Test user created successfully
- Test property created successfully
- Test booking created with payment status "paid"
- Booking amount: ₹7,500 (3 nights × ₹2,500)

---

## 🎯 Step 2: Test User Login

### 2.1 Login as Test User

1. **Open your browser** and go to `http://localhost:3000`
2. **Click "Login"** in the header
3. **Enter credentials:**
   - Email: `test@baithaka.com`
   - Password: `testpassword123`
4. **Click "Sign In"**

### 2.2 Verify Login

- ✅ You should be logged in successfully
- ✅ Your name should appear in the header
- ✅ You should have access to user dashboard

---

## 📖 Step 3: View Test Booking

### 3.1 Navigate to Bookings

1. **Click on your profile** in the header
2. **Select "My Bookings"** or go directly to `http://localhost:3000/bookings`

### 3.2 Verify Test Booking

You should see:

- ✅ **Test booking** in the "Upcoming" tab
- ✅ **Property name**: "Test Property for Booking Flow"
- ✅ **Booking amount**: ₹7,500
- ✅ **Status**: "Confirmed" (green badge)
- ✅ **Check-in date**: 7 days from today
- ✅ **Check-out date**: 10 days from today

### 3.3 Booking Details

- **Booking Code**: Should show format like `BK-XXXXXX`
- **Payment Status**: Should show "Paid"
- **Cancel Button**: Should be visible and enabled

---

## 💳 Step 4: Test New Booking Flow (Optional)

### 4.1 Create a New Booking

1. **Go to homepage** `http://localhost:3000`
2. **Search for a property** or browse properties
3. **Select a property** and click "Book Now"
4. **Fill booking details:**
   - Check-in date (future date)
   - Check-out date
   - Number of guests
5. **Click "Proceed to Payment"**

### 4.2 Test Payment Flow

1. **Payment Gateway**: You'll be redirected to Razorpay
2. **Test Payment**: Use Razorpay test cards:
   - **Success**: `4111 1111 1111 1111`
   - **Failure**: `4000 0000 0000 0002`
3. **Complete Payment**: Enter any future expiry date and CVV

### 4.3 Verify Payment Success

- ✅ **Booking confirmed** message
- ✅ **Payment status**: "paid"
- ✅ **Booking appears** in "Upcoming" tab

---

## ❌ Step 5: Test Cancellation Flow

### 5.1 Cancel the Test Booking

1. **Go to** `http://localhost:3000/bookings`
2. **Find the test booking** in "Upcoming" tab
3. **Click "Cancel"** button
4. **Confirm cancellation** in the popup

### 5.2 Verify Cancellation

- ✅ **Booking status** changes to "Cancelled"
- ✅ **Booking moves** to "Cancelled" tab
- ✅ **Toast notification** appears with cancellation message

---

## 💰 Step 6: Test Refund Flow

### 6.1 Check Refund Processing

After cancellation, you should see:

#### **If Automatic Refund Succeeds:**

- ✅ **Toast notification**: "Booking Cancelled with Refund"
- ✅ **Refund dialog** appears automatically
- ✅ **Refund amount**: ₹7,500
- ✅ **Refund status**: "Processed"
- ✅ **Refund ID**: Generated by Razorpay

#### **If Manual Refund Required:**

- ✅ **Toast notification**: "Booking Cancelled with Refund"
- ✅ **Refund dialog** appears automatically
- ✅ **Refund amount**: ₹7,500
- ✅ **Refund status**: "Processing"
- ✅ **Manual instructions** provided

### 6.2 Refund Dialog Details

The refund dialog should show:

- ✅ **Refund amount** prominently displayed
- ✅ **Processing timeline** (3-5 days for automatic, 5-7 days for manual)
- ✅ **Contact information** for support
- ✅ **Important notes** about refund process

### 6.3 Verify Database Updates

Check that the booking has been updated with:

- ✅ **Status**: "cancelled"
- ✅ **Payment Status**: "refunded"
- ✅ **Refund Amount**: ₹7,500
- ✅ **Refunded At**: Current timestamp
- ✅ **Cancellation Reason**: "Manual cancellation by user"

---

## 🔍 Step 7: Admin Verification

### 7.1 Login as Admin

1. **Go to** `http://localhost:3000/admin/login`
2. **Login with admin credentials**
3. **Navigate to** `http://localhost:3000/admin/bookings`

### 7.2 Verify Admin View

In admin bookings, you should see:

- ✅ **Test booking** in the list
- ✅ **Status**: "Cancelled"
- ✅ **Payment Status**: "Refunded"
- ✅ **Refund Amount**: ₹7,500
- ✅ **Cancellation details** in booking information

### 7.3 Test Admin Cancellation

1. **Find the test booking** in admin list
2. **Click dropdown** (three dots)
3. **Select "Cancel Booking"**
4. **Confirm cancellation**
5. **Verify** refund processing works from admin side too

---

## 🧪 Step 8: Test Edge Cases

### 8.1 Test Refund API Directly

```bash
# Test refund status API
curl -X GET "http://localhost:3000/api/bookings/{BOOKING_ID}/refund" \
  -H "Cookie: your-session-cookie"
```

### 8.2 Test Refund Service

```bash
# Test refund service (admin only)
curl -X POST "http://localhost:3000/api/test-refund" \
  -H "Cookie: your-admin-session-cookie"
```

### 8.3 Test Different Payment Statuses

1. **Create booking with payment status "pending"**
2. **Cancel it** - should not trigger refund
3. **Create booking with payment status "failed"**
4. **Cancel it** - should not trigger refund

---

## 📊 Step 9: Monitor Logs

### 9.1 Check Console Logs

During testing, monitor these log messages:

- ✅ `[BookingService] Processing refund for paid booking`
- ✅ `[RefundService] Processing refund for booking: {id}`
- ✅ `[RefundService] Razorpay refund successful: {refund_id}`
- ✅ `[RefundService] Refund processed successfully`

### 9.2 Check Database

Verify in MongoDB:

```javascript
// Check booking status
db.bookings.findOne({ _id: ObjectId("your-booking-id") });

// Check refund fields
db.bookings.findOne(
  { _id: ObjectId("your-booking-id") },
  { refundAmount: 1, refundStatus: 1, refundedAt: 1, paymentStatus: 1 }
);
```

---

## 🎯 Expected Results

### ✅ Successful Flow:

1. **Booking Creation**: ✅ User can create booking
2. **Payment Processing**: ✅ Payment gateway integration works
3. **Booking Confirmation**: ✅ Booking appears in upcoming
4. **Cancellation**: ✅ User can cancel booking
5. **Refund Processing**: ✅ Automatic refund through Razorpay
6. **Refund Instructions**: ✅ User sees detailed refund dialog
7. **Status Updates**: ✅ Database properly updated
8. **Admin View**: ✅ Admin can see all refund details

### ❌ Common Issues to Check:

- **Payment Gateway**: Ensure Razorpay credentials are set
- **Database Connection**: Verify MongoDB connection
- **Session Management**: Check user authentication
- **API Endpoints**: Verify all refund APIs are working
- **UI Components**: Ensure refund dialog displays correctly

---

## 🔧 Troubleshooting

### Issue: Refund not processing

**Solution:**

1. Check Razorpay credentials in `.env`
2. Verify payment ID exists in booking
3. Check console for error messages
4. Test with manual refund fallback

### Issue: Refund dialog not showing

**Solution:**

1. Check browser console for errors
2. Verify refund data structure
3. Ensure Dialog component is imported
4. Check React state management

### Issue: Database not updating

**Solution:**

1. Check MongoDB connection
2. Verify booking ID format
3. Check user authorization
4. Review database schema

---

## 🎉 Success Criteria

You've successfully tested the complete flow when:

- ✅ User can create and pay for booking
- ✅ Booking appears in upcoming with "Confirmed" status
- ✅ User can cancel booking with confirmation
- ✅ Refund processes automatically through Razorpay
- ✅ Refund dialog shows with detailed instructions
- ✅ Booking moves to "Cancelled" tab
- ✅ Admin can see all refund details
- ✅ Database properly tracks all refund information

**Congratulations! 🎉 Your booking, payment, cancellation, and refund system is working perfectly!**
